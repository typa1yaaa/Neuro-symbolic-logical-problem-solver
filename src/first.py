import subprocess
import re
import os

class LogicFormalizer:
    def __init__(self, model_name="deepseek-v3.1:671b-cloud"):
        self.model_name = model_name
    
    def formalize_problem(self, user_input: str):
        """
        –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ –Ω–∞–±–æ—Ä —Ñ–æ—Ä–º—É–ª –ª–æ–≥–∏–∫–∏ –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤
        """
        prompt = f"""
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–µ. –ü—Ä–µ–æ–±—Ä–∞–∑—É–π —Å–ª–µ–¥—É—é—â—É—é —Ç–µ–∫—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É –≤ –Ω–∞–±–æ—Ä —Ñ–æ—Ä–º—É–ª –ª–æ–≥–∏–∫–∏ –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤. 

–ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–µ–¥–∏–∫–∞—Ç—ã —Ç–∏–ø–∞ –ß–µ–ª–æ–≤–µ–∫(x), –°–º–µ—Ä—Ç–µ–Ω(x), –ì–æ–≤–æ—Ä–∏—Ç–ü—Ä–∞–≤–¥—É(x). 
–í—ã–≤–µ–¥–∏ –¢–û–õ–¨–ö–û —Ñ–æ—Ä–º—É–ª—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ü—Ä–µ–¥–∏–∫–∞—Ç(–û–±—ä–µ–∫—Ç) –∏–ª–∏ ¬¨–ü—Ä–µ–¥–∏–∫–∞—Ç(–û–±—ä–µ–∫—Ç), —Ä–∞–∑–¥–µ–ª—è—è –∏—Ö –∑–∞–ø—è—Ç—ã–º–∏.

–í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê:
1. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ –∏–º–µ–Ω–∞ –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤: –î–æ–∂–¥—å(x), –ú–æ–∫—Ä–∞—è–£–ª–∏—Ü–∞(x)
2. –î–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º–∞—Ç: ‚àÄx(–ü—Ä–µ–¥–∏–∫–∞—Ç(x)‚Üí–î—Ä—É–≥–æ–π–ü—Ä–µ–¥–∏–∫–∞—Ç(x))
3. –ï—Å–ª–∏ –≤ –∑–∞–¥–∞—á–µ –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ –î–û–ö–ê–ó–ê–¢–¨, –æ–ø—Ä–µ–¥–µ–ª–∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏ –¥–æ–±–∞–≤—å –û–¢–†–ò–¶–ê–ù–ò–ï —ç—Ç–æ–≥–æ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
4. –ï—Å–ª–∏ –≤ –∑–∞–¥–∞—á–µ –£–ñ–ï –µ—Å—Ç—å –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ ("–Ω–µ", "–ª–æ–∂—å", "–Ω–µ–≤–µ—Ä–Ω–æ"), —Ç–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ–º–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ - —ç—Ç–æ —Ç–æ, —á—Ç–æ —Å–ª–µ–¥—É–µ—Ç –∏–∑ –ø–æ—Å—ã–ª–æ–∫
5. –ò—Å–ø–æ–ª—å–∑—É–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∏–º–µ–Ω–∞ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤

–ü—Ä–∏–º–µ—Ä—ã:
–í—Ö–æ–¥: "–°–æ–∫—Ä–∞—Ç ‚Äî —á–µ–ª–æ–≤–µ–∫. –í—Å–µ –ª—é–¥–∏ —Å–º–µ—Ä—Ç–Ω—ã. –î–æ–∫–∞–∂–∏, —á—Ç–æ –°–æ–∫—Ä–∞—Ç —Å–º–µ—Ä—Ç–µ–Ω."
–í—ã—Ö–æ–¥: –ß–µ–ª–æ–≤–µ–∫(–°–æ–∫—Ä–∞—Ç), ‚àÄx(–ß–µ–ª–æ–≤–µ–∫(x)‚Üí–°–º–µ—Ä—Ç–µ–Ω(x)), ¬¨–°–º–µ—Ä—Ç–µ–Ω(–°–æ–∫—Ä–∞—Ç)

–í—Ö–æ–¥: "–í—Å–µ –∫–æ—à–∫–∏ –∂–∏–≤–æ—Ç–Ω—ã–µ. –ú—É—Ä–∫–∞ –∫–æ—à–∫–∞. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –ú—É—Ä–∫–∞ –∂–∏–≤–æ—Ç–Ω–æ–µ."
–í—ã—Ö–æ–¥: ‚àÄx(–ö–æ—à–∫–∞(x)‚Üí–ñ–∏–≤–æ—Ç–Ω–æ–µ(x)), –ö–æ—à–∫–∞(–ú—É—Ä–∫–∞), ¬¨–ñ–∏–≤–æ—Ç–Ω–æ–µ(–ú—É—Ä–∫–∞)

–í—Ö–æ–¥: "–í—Å–µ —á–µ—Å—Ç–Ω—ã–µ –ª—é–¥–∏ –≥–æ–≤–æ—Ä—è—Ç –ø—Ä–∞–≤–¥—É. –î–∂–æ–Ω –ª–∂–µ—Ç. –î–æ–∫–∞–∂–∏, —á—Ç–æ –î–∂–æ–Ω –Ω–µ —á–µ—Å—Ç–Ω—ã–π —á–µ–ª–æ–≤–µ–∫."
–í—ã—Ö–æ–¥: ‚àÄx(–ß–µ—Å—Ç–Ω—ã–π(x)‚Üí–ì–æ–≤–æ—Ä–∏—Ç–ü—Ä–∞–≤–¥—É(x)), ¬¨–ì–æ–≤–æ—Ä–∏—Ç–ü—Ä–∞–≤–¥—É(–î–∂–æ–Ω), –ß–µ—Å—Ç–Ω—ã–π(–î–∂–æ–Ω)

–í—Ö–æ–¥: "–ï—Å–ª–∏ –∏–¥–µ—Ç –¥–æ–∂–¥—å, —Ç–æ —É–ª–∏—Ü–∞ –º–æ–∫—Ä–∞—è. –î–æ–∂–¥—å –∏–¥–µ—Ç. –ó–Ω–∞—á–∏—Ç, —É–ª–∏—Ü–∞ –º–æ–∫—Ä–∞—è."
–í—ã—Ö–æ–¥: ‚àÄx(–î–æ–∂–¥—å(x)‚Üí–ú–æ–∫—Ä–∞—è–£–ª–∏—Ü–∞(x)), –î–æ–∂–¥—å(—Å–µ–π—á–∞—Å), ¬¨–ú–æ–∫—Ä–∞—è–£–ª–∏—Ü–∞(—Å–µ–π—á–∞—Å)

–¢–µ–ø–µ—Ä—å –ø—Ä–µ–æ–±—Ä–∞–∑—É–π —Å–ª–µ–¥—É—é—â—É—é –∑–∞–¥–∞—á—É:
{user_input}
        """
        
        try:
            # –ó–∞–ø—É—Å–∫–∞–µ–º Ollama
            ollama_path = os.path.join(
                os.environ["LOCALAPPDATA"],
                "Programs", "Ollama", "ollama.exe"
            )

            result = subprocess.run([
                ollama_path,
                "run",
                self.model_name,
                prompt
            ], capture_output=True, text=True, timeout=120, encoding='utf-8')
            
            if result.returncode == 0:
                raw_output = result.stdout.strip()
                formulas = self.clean_formulas(raw_output)
                return formulas
            else:
                return ["–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–∏"]
                
        except subprocess.TimeoutExpired:
            return ["–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞"]
        except Exception as e:
            return [f"–û—à–∏–±–∫–∞: {str(e)}"]
    
    def clean_formulas(self, raw_output: str):
        """–û—á–∏—â–∞–µ—Ç –≤—ã–≤–æ–¥ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ñ–æ—Ä–º—É–ª—ã"""
        # –£–±–∏—Ä–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        cleaned = re.sub(r'Thinking\.\.\..*?\.\.\.done thinking\.', '', raw_output, flags=re.DOTALL)
        
        # –ò—â–µ–º —Ñ–æ—Ä–º—É–ª—ã (—Å–æ–¥–µ—Ä–∂–∞—Ç —Å–∫–æ–±–∫–∏, –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–≤–∞–Ω—Ç–æ—Ä—ã, –æ—Ç—Ä–∏—Ü–∞–Ω–∏—è)
        lines = cleaned.strip().split('\n')
        for line in lines:
            line = line.strip()
            if not line or 'Thinking' in line:
                continue
            
            # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ñ–æ—Ä–º—É–ª, —Ä–∞–∑–¥–µ–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—è—Ç—ã–º–∏
            if any(char in line for char in ['(', ')', '‚àÄ', '‚àÉ', '¬¨', '‚Üí']):
                # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ –æ—á–∏—â–∞–µ–º
                formulas = [f.strip() for f in line.split(",") if f.strip()]
                # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã
                valid_formulas = []
                for formula in formulas:
                    if self.is_valid_formula(formula):
                        valid_formulas.append(formula)
                if valid_formulas:
                    return valid_formulas
        
        return ["–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ñ–æ—Ä–º—É–ª—ã"]
    
    def is_valid_formula(self, formula: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –≤–∞–ª–∏–¥–Ω–æ–π —Ñ–æ—Ä–º—É–ª–æ–π"""
        # –î–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å–∫–æ–±–∫–∏ –∏–ª–∏ –±—ã—Ç—å –∫–≤–∞–Ω—Ç–æ—Ä–æ–º
        if '(' in formula and ')' in formula:
            return True
        if formula.startswith('‚àÄ') or formula.startswith('‚àÉ'):
            return True
        return False

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ —Å –æ—Ç—Ä–∏—Ü–∞–Ω–∏—è–º–∏
def test_formalizer_with_negations():
    formalizer = LogicFormalizer()
    
    test_cases = [
        # –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏
        "–°–æ–∫—Ä–∞—Ç ‚Äî —á–µ–ª–æ–≤–µ–∫. –í—Å–µ –ª—é–¥–∏ —Å–º–µ—Ä—Ç–Ω—ã. –î–æ–∫–∞–∂–∏, —á—Ç–æ –°–æ–∫—Ä–∞—Ç —Å–º–µ—Ä—Ç–µ–Ω.",
        
        # –ó–∞–¥–∞—á–∏ —Å –æ—Ç—Ä–∏—Ü–∞–Ω–∏—è–º–∏ –≤ –ø–æ—Å—ã–ª–∫–∞—Ö
        "–í—Å–µ —á–µ—Å—Ç–Ω—ã–µ –ª—é–¥–∏ –≥–æ–≤–æ—Ä—è—Ç –ø—Ä–∞–≤–¥—É. –î–∂–æ–Ω –ª–∂–µ—Ç. –î–æ–∫–∞–∂–∏, —á—Ç–æ –î–∂–æ–Ω –Ω–µ —á–µ—Å—Ç–Ω—ã–π —á–µ–ª–æ–≤–µ–∫.",
        "–í—Å–µ –º–ª–µ–∫–æ–ø–∏—Ç–∞—é—â–∏–µ —Ç–µ–ø–ª–æ–∫—Ä–æ–≤–Ω—ã–µ. –ó–º–µ—è –Ω–µ —Ç–µ–ø–ª–æ–∫—Ä–æ–≤–Ω–∞—è. –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∑–º–µ—è –Ω–µ –º–ª–µ–∫–æ–ø–∏—Ç–∞—é—â–µ–µ.",
        
        # –ó–∞–¥–∞—á–∏ —Å –æ—Ç—Ä–∏—Ü–∞–Ω–∏—è–º–∏ –≤ —Ü–µ–ª–∏
        "–í—Å–µ —Ä—ã–±—ã –∂–∏–≤—É—Ç –≤ –≤–æ–¥–µ. –ö–∏—Ç –Ω–µ —Ä—ã–±–∞. –î–æ–∫–∞–∂–∏, —á—Ç–æ –∫–∏—Ç –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∂–∏–≤–µ—Ç –≤ –≤–æ–¥–µ.",
        "–í—Å–µ –ø—Ç–∏—Ü—ã –ª–µ—Ç–∞—é—Ç. –ü–∏–Ω–≥–≤–∏–Ω –Ω–µ –ª–µ—Ç–∞–µ—Ç. –ó–Ω–∞—á–∏—Ç, –ø–∏–Ω–≥–≤–∏–Ω –Ω–µ –ø—Ç–∏—Ü–∞.",
        
        # –°–º–µ—à–∞–Ω–Ω—ã–µ —Å–ª—É—á–∞–∏
        "–ï—Å–ª–∏ —á–∏—Å–ª–æ —á–µ—Ç–Ω–æ–µ, —Ç–æ –æ–Ω–æ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 2. –ß–∏—Å–ª–æ 7 –Ω–µ –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 2. –î–æ–∫–∞–∂–∏, —á—Ç–æ —á–∏—Å–ª–æ 7 –Ω–µ —á–µ—Ç–Ω–æ–µ."
    ]
    
    print("üîç –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –§–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò –° –û–¢–†–ò–¶–ê–ù–ò–Ø–ú–ò")
    print("=" * 50)
    
    for i, test_case in enumerate(test_cases, 1):
        print(f"\nüìã –¢–µ—Å—Ç {i}: {test_case}")
        result = formalizer.formalize_problem(test_case)
        print(f"üìù –§–æ—Ä–º—É–ª—ã: {result}")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        has_negation = any('¬¨' in f for f in result)
        print(f"üîç –°–æ–¥–µ—Ä–∂–∏—Ç –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ: {has_negation}")
        
        if has_negation:
            negated_formulas = [f for f in result if '¬¨' in f]
            print(f"üìå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ—Ä–º—É–ª—ã: {negated_formulas}")

if __name__ == "__main__":
    test_formalizer_with_negations()