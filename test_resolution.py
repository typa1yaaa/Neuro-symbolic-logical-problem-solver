from src.resolution_engine import ResolutionEngine

def print_detailed_proof(log, engine):
    """Красиво выводит доказательство с нумерацией клауз"""
    print("\n" + "="*60)
    print("ДЕТАЛИЗИРОВАННОЕ ДОКАЗАТЕЛЬСТВО")
    print("="*60)

    # Выводим исходные клаузы
    print("ИСХОДНЫЕ КЛАУЗЫ:")
    for step in log:
        if step['type'] == 'initial':
            for clause_info in step['clauses']:
                print(f"{clause_info['id']}. {clause_info['clause']}  [{clause_info['source']}]")
            break
    print("-" * 40)

    # Выводим шаги резолюции
    print("ШАГИ РЕЗОЛЮЦИИ:")
    for step in log:
        if step['type'] == 'resolution_step':
            clause1_id = step['clause1_id']
            clause2_id = step['clause2_id']
            resolvent_id = step['resolvent_id']
            resolvent = step['resolvent']

            print(f"{resolvent_id}. {resolvent}  [резолюция {clause1_id} и {clause2_id}]")
            if step['unification']:
                print(f"   Унификация: {step['unification']}")

        elif step['type'] == 'contradiction_found':
            print("-" * 40)
            print(f" НАЙДЕНО ПРОТИВОРЕЧИЕ! Доказательство завершено.")
            clause_id = step['clause_id']
            parents = step['parents']
            print(f"Пустая клауза {clause_id} получена из клауз {parents}")


# Тестирование
def test_resolution_engine():
    """Тестирование движка резолюций с улучшенным выводом"""
    engine = ResolutionEngine()

    # Пример 1: Классический силлогизм
    print("=== ТЕСТ 1: Сократ смертен ===")
    clauses = [
        "Человек(Сократ)",
        "¬Человек(x) ∨ Смертен(x)", 
        "¬Смертен(Сократ)"
    ]

    success, log = engine.prove(clauses)
    print(f"Результат доказательства: {success}")
    print_detailed_proof(log, engine)

    # Пример 2: С квантором существования (ИСПРАВЛЕННЫЙ ВВОД)
    print("\n" + "="*60)
    print("=== ТЕСТ 2: Студент сдал экзамен ===")
    clauses2 = [
        "¬Студент(x) ∨ СдалЭкзамен(x, f(x))",  # ЗАКРЫТАЯ СКОБКА!
        "Студент(Иван)",
        "¬СдалЭкзамен(Иван, y)"
    ]

    success2, log2 = engine.prove(clauses2)
    print(f"Результат доказательства: {success2}")
    print_detailed_proof(log2, engine)


    # Пример 3: Три предиката
    print("\n" + "="*60)
    print("=== ТЕСТ 3: Три предиката (конкретный пример) ===")
    print("Если кто-то студент, то он учится в университете.")
    print("Если кто-то учится в университете, то он сдает экзамены.")
    print("Иван - студент, но он не сдает экзамены.")

    clauses3 = [
        "Студент(Иван)",
        "¬Студент(x) ∨ УчитсяВУниверситете(x)", 
        "¬УчитсяВУниверситете(y) ∨ СдаетЭкзамены(y)",
        "¬СдаетЭкзамены(Иван)"
    ]

    success3, log3 = engine.prove(clauses3)
    print(f"Результат доказательства: {success3}")
    print_detailed_proof(log3, engine)

    # "Если A больше B, и B больше C, то A больше C. A больше B, B больше C. Докажи, что A больше C."
    print("\n" + "="*60)
    print("=== ТЕСТ 4: Транзитивность ===")
    print("Если A больше B, и B больше C, то A больше C. A больше B, B больше C. Докажи, что A больше C.")

    clauses4 = [
        "Больше(A, B)",
        "Больше(B, C)",
        "¬Больше(x, y) ∨ ¬Больше(y, z) ∨ Больше(x, z)",  # Транзитивность
        "¬Больше(A, C)"  # Отрицание того, что нужно доказать
    ]

    success4, log4 = engine.prove(clauses4)
    print(f"Результат доказательства: {success4}")
    print_detailed_proof(log4, engine)

    # "Каждый студент изучает какой-то предмет. Математику изучают только умные. Петя - студент. Докажи, что Петя умный."
    print("\n" + "="*60)
    print("=== ТЕСТ 5: Сложная логика ===")
    print("Каждый студент изучает какой-то предмет. Математику изучают только умные. Петя - студент. Докажи, что Петя умный.")

    clauses5 = [
        "Студент(Петя)",
        "¬Студент(x) ∨ Изучает(x, f(x))",  # Каждый студент изучает какой-то предмет f(x)
        "¬Изучает(y, Математика) ∨ Умный(y)",  # Изучающие математику - умные
        "¬Умный(Петя)"  # Отрицание того, что нужно доказать
    ]

    success5, log5 = engine.prove(clauses5)
    print(f"Результат доказательства: {success5}")
    print_detailed_proof(log5, engine)


    # Тест 6: Симметричные отношения
    print("\n" + "="*60)
    print("=== ТЕСТ 6: Симметричность ===")
    clauses6 = [
        "Друг(Алиса, Боб)",
        "¬Друг(x, y) ∨ Друг(y, x)",  # Симметричность
        "¬Друг(Боб, Алиса)"  # Отрицание симметричности
    ]
    success6, log6 = engine.prove(clauses6)
    print(f"Результат доказательства: {success6}")
    print_detailed_proof(log6, engine)

    # Тест 7: Множественные переменные
    print("\n" + "="*60)
    print("=== ТЕСТ 7: Множественные переменные ===")
    clauses7 = [
        "R(a, b)",
        "¬R(x, y) ∨ S(y, x)",
        "¬S(b, a)"  # Отрицание того, что должно следовать
    ]
    success7, log7 = engine.prove(clauses7)
    print(f"Результат доказательства: {success7}")
    print_detailed_proof(log7, engine)

    # ТЕСТ 8: Кто-то украл пирог
    print("\n" + "="*60)
    print("=== ТЕСТ 8: Кто украл пирог? ===")
    print("В доме были только мама, папа и ребёнок. Пирог украл тот, кто был дома и любит сладкое.")
    print("Ребёнок любит сладкое. Папа не любит сладкое. Докажи, что пирог украл ребёнок.")

    clauses8 = [
        "БылДома(ребёнок)",
        "БылДома(мама)",
        "БылДома(папа)",
        "¬БылДома(x) ∨ ¬ЛюбитСладкое(x) ∨ УкралПирог(x)",  # только тот, кто был дома и любит сладкое
        "ЛюбитСладкое(ребёнок)",
        "¬ЛюбитСладкое(папа)",
        "¬УкралПирог(ребёнок)"  # опровергнем это
    ]
    success8, log8 = engine.prove(clauses8)
    print(f"Результат доказательства: {success8}")
    print_detailed_proof(log8, engine)

    # ТЕСТ 9: Волк, коза и капуста (классическая головоломка в логике)
    print("\n" + "="*60)
    print("=== ТЕСТ 9: Волк, коза и капуста ===")
    print("Если волк остаётся с козой без фермера — волк съест козу.")
    print("Если коза остаётся с капустой без фермера — коза съест капусту.")
    print("Сейчас фермера нет, волк, коза и капуста на одном берегу. Докажи, что что-то будет съедено.")

    clauses9 = [
        "¬ФермерПрисутствует",
        "НаОдномБерегу(волк, коза)",
        "НаОдномБерегу(коза, капуста)",
        "¬ФермерПрисутствует ∨ ¬НаОдномБерегу(волк, коза) ∨ ¬Съест(волк, коза)",
        "¬ФермерПрисутствует ∨ ¬НаОдномБерегу(коза, капуста) ∨ ¬Съест(коза, капуста)",
        "¬Съест(волк, коза) ∨ ¬Съест(коза, капуста)"  # опровергнем, что оба НЕ съедят
    ]
    success9, log9 = engine.prove(clauses9)
    print(f"Результат доказательства: {success9}")
    print_detailed_proof(log9, engine)

    # ТЕСТ 10: Тайный поклонник
    print("\n" + "="*60)
    print("=== ТЕСТ 10: Тайный поклонник ===")
    print("Кто-то из трёх парней (Антон, Борис, Виктор) — тайный поклонник Маши.")
    print("Тайный поклонник дарит цветы каждый день. Антон вчера не дарил цветы.")
    print("Борис дарит цветы только по понедельникам, а сегодня среда. Докажи, что поклонник — Виктор.")

    clauses10 = [
        "Поклонник(Антон) ∨ Поклонник(Борис) ∨ Поклонник(Виктор)",  # кто-то из них
        "¬Поклонник(x) ∨ ДаритЦветыКаждыйДень(x)",
        "¬ДаритЦветыКаждыйДень(Антон)",   # вчера не дарил → не каждый день
        "¬Понедельник ∨ ДаритЦветы(Борис)",   # обратное: если не понедельник → Борис НЕ дарит
        "¬Понедельник",
        "¬Поклонник(Виктор)"  # попробуем опровергнуть
    ]
    success10, log10 = engine.prove(clauses10)
    print(f"Результат доказательства: {success10}")
    print_detailed_proof(log10, engine)

    # ТЕСТ 11: Лжец и правдивый на острове
    print("\n" + "="*60)
    print("=== ТЕСТ 11: Остров лжецов и правдивых ===")
    print("На острове либо всегда лгут, либо всегда говорят правду.")
    print("Абориген сказал: «Я — лжец». Докажи, что это невозможно.")

    clauses11 = [
        "Лжец(абориген) ∨ Правдивый(абориген)",        # кто-то один
        "¬Лжец(абориген) ∨ ¬Сказал(абориген, 'Я лжец')",  # лжец не может сказать правду
        "¬Правдивый(абориген) ∨ Сказал(абориген, 'Я лжец')",  # правдивый сказал бы правду
        "Сказал(абориген, 'Я лжец')"
        # Противоречие автоматически выведется
    ]
    success11, log11 = engine.prove(clauses11)
    print(f"Результат доказательства: {success11}")
    print_detailed_proof(log11, engine)

    # ТЕСТ 12: Преступление в восточном экспрессе
    print("\n" + "="*60)
    print("=== ТЕСТ 12: Все виноваты  ===")
    print("Убийство совершил либо один человек, либо все пассажиры вагона вместе.")
    print("Если один — то у него был мотив и возможность. Ни у кого одного не было и мотива, и возможности одновременно.")
    print("Убийство совершено. Докажи, что виноваты все.")

    clauses12 = [
        "УбийствоСовершено",
        "ВиноватОдин ∨ ВиноватыВсе",
        "¬ВиноватОдин ∨ ЕстьМотивИВозможность(кто-то)",
        "¬ЕстьМотивИВозможность(все_пассажиры_по_отдельности)",
        "¬ВиноватыВсе"  # опровергнем
    ]

    success12, log12 = engine.prove(clauses12)
    print(f"Результат доказательства: {success12}")
    print_detailed_proof(log12, engine)

    # ТЕСТ 13: Вампиры и чеснок
    print("\n" + "="*60)
    print("=== ТЕСТ 13: Вампиры боятся чеснока ===")
    print("Все вампиры боятся чеснока. Некоторые бессмертные — вампиры.")
    print("Дракула бессмертный и ест чеснок. Докажи, что Дракула не вампир.")

    clauses13 = [
        "¬Вампир(x) ∨ БоитсяЧеснока(x)",
        "Бессмертный(Дракула)",
        "ЕстЧеснок(Дракула)",
        "¬ЕстЧеснок(y) ∨ ¬БоитсяЧеснока(y)",  # кто ест — тот не боится
        "Бессмертный(z) ∨ Вампир(z)",         # некоторые бессмертные — вампиры (обратное для опровержения)
        "Вампир(Дракула)"                     # предположим и опровергнем
    ]
    success13, log13 = engine.prove(clauses13)
    print(f"Результат доказательства: {success13}")
    print_detailed_proof(log13, engine)







if __name__ == "__main__":
    test_resolution_engine()